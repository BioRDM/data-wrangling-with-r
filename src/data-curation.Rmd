---
title: "Data wrangling with R"
author: "Sumy V Baby, Tomasz Zielinski"
date: "2022-03-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Welcome to data wrangling with R.

This and the following R-Markdown notebooks have been inspired by our real data curation work for the project about monitoring COVID virus levels in wastewater around Scotland ([see project page](https://biordm.github.io/COVID-Wastewater-Scotland/)).

Firstly, check our raw data.

## Inspecting RAW DATA

Our raw data are included in the raw_data folder of this project. Let's check what it contains

```{r}
list.files("../raw_data")
```
*** The `../raw_data` means that we are going to navigate to the parent folder (we are in src folder) cause we use `..` and then we will list the content of the `raw_data` folder. ***

Let's read measurements from the RNA Monitoring Project file

```{r}
raw_data <- read.csv("../raw_data/2022_02_14-RNA_Monitoring_Project.csv")
head(raw_data)

```
`read.csv` read content of the file into `raw_data` variable.  
`head(raw_data)` printed first few rows of the data.

To have it as a nice wide table rather than wrapped around when generating r-markdown report we can use:

```{r}
knitr::kable(
  head(raw_data),
  caption = "COVID RNA levels in wastewater"
)
```
Some of the columns have . in their name, it is because the original file contained columns names with space. It is generally a bad practice to have spaces in columns names.
Also some columns are not descriptive enough, for example `HBOARD` stands for health board and the `Date` is actually a date on which the samples were collected.

So let's rename the columns.

## Renaming columns

```{r}
renamed_data <- raw_data
names(renamed_data)[1] <- "Health_Board"
names(renamed_data)[3] <- "Date_collected"
head(renamed_data[1:5])

```
`names` in base R can be used to both read the column names or to set it, depending if it is used in assignment or not.

That approach is error prone and tedious as we need to use the correct column index (see that date was in column 3 not 2).

### Renaming by selection
It would be better if we could select which columns we want to rename and provide new names.  
For example:

```{r}
old_name = c("HBNAME","Date","Date.Analysed")
new_name = c("Health_Board","Date_collected","Date_analysed")
renamed_data <- raw_data
names(renamed_data)[names(renamed_data) %in% old_name] = new_name
head(renamed_data[1:5])

```
We still need to provide the new names in the right order!

Probably less error prone is actually to get all the existing names, change them and set back.

### Renaming all
For that we need a vector with new names, we could generate a text template with a following command
```{r }
print(paste0("'", names(raw_data),"'", collapse=","))
```
We used ' so that the escape \" character won't be printed
Now we can edit the columns ones by one and use to set the new names
```{r}
new_name = c('Health_Board','Site','Date_collected','Date_analysed','SW_sample_number','N1.Description','N1.Reported.Value','N1.Sample.1','N1.Sample.2','N1.Sample.3','Calculated.Mean','Standard.Deviation','Flow..l.day.','Ammonia..mg.l.','pH.Value','Modelled.Flow..l.day.','Million.Gene.Copies.Per.Person.per.Day','Analysis.Lab','X.Row.Count.')
renamed_data <- raw_data
names(renamed_data) = new_name
head(renamed_data[1:5])

```

The best solution would be to provide names dictionary, which will match old names with new names. That way we will be resilient to changes in the columns order.

### Renaming with dictionary

```{r}
dictionary <- data.frame(
  old_name = c("Date",          "Date.Analysed", "HBNAME"),
  new_name = c("Date_collected","Date_analysed", "Health_Board")
)
renamed_data <- raw_data
names(renamed_data)[match(dictionary$old_name, names(renamed_data))] <- dictionary$new_name
head(renamed_data[1:5])
```
Look how the first column was renamed even it was the last one in our dictionary.

We could of course create a file with the old and new names, and read the mappings from there. Try to do it yourself.

So lets rename all the columns using two lists of names


```{r}
dictionary <- data.frame(
  old_name = c('HBNAME','Site','Date','Date.Analysed','SW.Sample.Number','N1.Description','N1.Reported.Value','N1.Sample.1','N1.Sample.2','N1.Sample.3','Calculated.Mean','Standard.Deviation','Flow..l.day.','Ammonia..mg.l.','pH.Value','Modelled.Flow..l.day.','Million.Gene.Copies.Per.Person.per.Day','Analysis.Lab','X.Row.Count.'),

  new_name = c("Health_Board","Site","Date_collected","Date_analysed", "SW_sample_number","N1_description", "N1_Reported_value-gc_per_L","N1_Repl_1-gc_per_L","N1_Repl_2-gc_per_L","N1_Repl_3-gc_per_L","Calculated_mean","Standard_Deviation","Flow-L_per_day","Ammonia-mg_per_L","pH_value","Modelled_flow-L_per_day","Million_gene_copies_per_person_per_day","Analysis_lab","Row_count")
)
renamed_data <- raw_data
names(renamed_data)[match(dictionary$old_name, names(renamed_data))] <- dictionary$new_name
head(renamed_data[1:5])
```

Let's save our renamed data into a file.

```{r}
if (!file.exists('../data')) {
  dir.create(file.path('..', 'data'))  
}

fName = '../data/renamed_data.csv'
write.csv(renamed_data, fName)

```

We first checked if the output directory exists, if not create it and then we saved the file.


